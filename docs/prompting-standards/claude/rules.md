# Rules プロンプティング規約

Claude Code のルール機能（`.claude/rules/`）を定義する際の規約を定める。

## 概要

### ルール機能とは

プロジェクト固有のガイドラインを、複数のマークダウンファイルに分割して管理する機能。CLAUDE.md の補完として機能し、トピック別に指示を整理できる。

### メモリ階層

```
Enterprise Policy（最高優先度）
    ↓
Project Memory（.claude/CLAUDE.md）
    ↓
Project Rules（.claude/rules/*.md）← ルール機能
    ↓
User Memory（~/.claude/CLAUDE.md）
    ↓
Local Memory（.claude.local.md）（最低優先度）
```

## 配置

### スコープ別配置場所

| スコープ | 場所 | 共有範囲 | 用途 |
|---------|------|---------|------|
| プロジェクト | `./.claude/rules/` | チーム全体（git経由） | プロジェクト固有ガイドライン |
| ユーザー | `~/.claude/rules/` | 個人（全プロジェクト） | 個人の設定や好み |

### ディレクトリ構造

```
.claude/rules/
├── code-style.md           # コードスタイル
├── testing.md              # テスト規約
├── security.md             # セキュリティ要件
├── frontend/               # サブディレクトリ可
│   ├── react.md
│   └── css.md
└── backend/
    └── api.md
```

## ファイル形式

### 命名規則

| 対象 | 規則 | 例 |
|------|------|-----|
| ファイル名 | 小文字、ハイフン区切り | `code-style.md` |
| ディレクトリ名 | 小文字、ハイフン区切り | `frontend/` |

**避けるべき名前:**

| 種類 | 例 |
|------|-----|
| 大文字 | `API_DESIGN.md` |
| スペース | `code style.md` |
| 曖昧 | `rules.md`, `guidelines.md` |

### マークダウン構造

```markdown
---
paths:
  - src/**/*.ts
---

# タイトル

導入文（1-2行で対象と目的を明示）

## セクション1

内容

## セクション2

内容
```

### Frontmatter

YAML形式で `paths` フィールドを指定する。

```yaml
---
paths:
  - src/**/*.ts
  - src/**/*.tsx
---
```

| 項目 | 説明 |
|------|------|
| `paths` | ルール適用対象のファイルパターン（省略可） |

## paths 指定

### 目的

特定のファイルタイプを操作する場合にのみルールを適用する。

### 読み込みと適用の違い

| 用語 | 動作 |
|------|------|
| 読み込み | セッション開始時にすべてのルールファイルがコンテキストに含まれる |
| 適用 | `paths` にマッチするファイルを操作する場合のみルールが有効化される |

### paths の有無による動作

| `paths` | 動作 |
|---------|------|
| 未定義 | 常に適用される |
| 定義あり | マッチするファイル操作時のみ適用される |

### 適用のトリガー

以下の操作時に `paths` パターンとのマッチングが判定される。

- Read ツールでファイルを読む
- Edit / Write ツールでファイルを編集・書き込む
- Grep / Glob ツールでファイルを検索する

会話でファイルパスに言及するだけでは適用されない。

### グロブパターン

| パターン | マッチ対象 |
|---------|----------|
| `**/*.ts` | すべての TypeScript ファイル |
| `src/**/*` | `src/` 配下すべてのファイル |
| `*.md` | プロジェクトルート直下のマークダウン |
| `src/components/*.tsx` | 特定ディレクトリの特定拡張子 |
| `{src,lib}/**/*.ts` | 複数ディレクトリをブレース展開 |
| `**/*.{ts,tsx}` | 複数拡張子 |

**複合パターン例:**

```yaml
---
paths:
  - {src,lib}/**/*.ts
  - tests/**/*.test.ts
---
```

## 設計原則

### 粒度

1ファイル = 1トピックを原則とする。

```
✓ 良い例:
- testing.md              # テスト全般
- code-style.md           # コードスタイル
- security.md             # セキュリティ

✗ 悪い例:
- all-guidelines.md       # 複数トピックを1ファイルに
```

### 構成

| 項目 | 規則 |
|------|------|
| 行数上限 | 300行以下を目安 |
| 超過時 | 分割または詳細を別ファイルに |
| 見出し | 概要から詳細への展開 |

**推奨構成:**

```markdown
# ルールタイトル

導入文

## 概要
何についてのルールか

## 実装ガイド
具体的な手順や例

## チェックリスト
確認事項

## 参考
関連リンク
```

### 内容

| 原則 | 説明 |
|------|------|
| 簡潔さ | Claude が既に知っていることは書かない |
| 具体性 | 曖昧な指示を避け、実行可能な形式で記述 |
| 一貫性 | 用語を統一する |

**良い例:**

```markdown
## コミットメッセージ

形式: `<type>: <subject>`

type は以下のいずれか:
- feat: 新機能
- fix: バグ修正
- docs: ドキュメント
```

**悪い例:**

```markdown
## コミットメッセージ

良いコミットメッセージを書いてください。
分かりやすく、適切な形式で書くことが重要です。
```

## CLAUDE.md との使い分け

| 内容 | CLAUDE.md | rules/ |
|------|-----------|--------|
| プロジェクト背景・概要 | ✓ | - |
| 利用可能なコマンド一覧 | ✓ | - |
| 主要ファイルの説明 | ✓ | - |
| コーディング標準 | - | ✓ |
| テスト規約 | - | ✓ |
| セキュリティ要件 | - | ✓ |
| ドキュメント形式 | - | ✓ |
| ファイルタイプ別ガイド | - | ✓ |

## 注意点

### パス指定の限界

`paths` 指定は Claude への「ヒント」として機能する。厳密な強制ではないため、重要な制約はプロジェクト設定で管理する。

### ルール間の矛盾

複数ルールが該当する場合の処理順序は不定。ルール間で矛盾しない設計を心がける。

### 運用上の制限

| 項目 | 制限 |
|------|------|
| ルール数 | 10個程度を目安 |
| ネスト深さ | import使用時は5レベルまで |
| ファイル形式 | テキスト（マークダウン）のみ |

## チェックリスト

### ルール作成時

```
[ ] トピック内容は単一か
[ ] ファイル名は小文字+ハイフン形式か
[ ] frontmatter形式は正しいか
[ ] paths指定は適切か（不要なら省略）
[ ] 見出し構造は論理的か
[ ] 指示は具体的で実行可能か
[ ] 他のルールと矛盾していないか
```

### ルール管理時

```
[ ] ルール数は10個以内か
[ ] ディレクトリ構成は明確か
[ ] 古いルールは削除されているか
[ ] 定期的にレビューしているか
```

## 参考

- [Claude Code Memory](https://docs.anthropic.com/en/docs/claude-code/memory) - 公式ドキュメント
